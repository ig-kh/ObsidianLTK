---
tags:
  - Graphs
  - Search
  - TODO
date: 2025-10-27
time: 22:24:09
location:
layer: bronze
---
Метод HNSW расширяет [[Метод NSW|NSW]] за счёт многоуровневой иерархической структуры графа. Верхние уровни содержат малое число вершин с длинными рёбрами для грубой навигации, нижний уровень содержит все вершины с более плотными локальными связями для точного поиска. Максимальный уровень $L_{\max}$ задаётся иерархически, а уровни вершин назначаются случайно по экспоненциальному распределению.

### Стадия построения графа
Дано: множество точек $X = \{x_1, x_2, \dots, x_n\}$, максимальное число соседей $M$, максимальный уровень $L_{\max}$, параметр качества построения $ef_{construction}$.
1. Инициализировать иерархию графов $G_0, G_1, \dots, G_{L_{\max}}$, каждый из которых пуст.
2. Для каждой точки $q \in X$:
	1. Случайно определить максимальный уровень $l_q$ по экспоненциальному распределению:
		$\mathbb{P}[l_q = l] = p (1 - p)^l, \quad l = 0,1,\dots, \quad p = \frac{1}{M}$
3. Для каждого уровня $l$  $l_q\rightarrow0$:
	1. Выполнить поиск в $G_l$ для нахождения множества ближайших соседей $\mathcal{N}^l(q)$ к $q$, максимальный размер поиска — $ef_{construction}$.

	2. Вставить $q$ в $G_l$ и соединить с $M$ ближайшими из $\mathcal{N}^l(q)$ (ребра двунаправленные, с поддержанием максимальной степени $M$).

4. Определить точку входа в иерархию на верхнем уровне для последующих поисков.

> Каждая вставка требует поиска на нескольких уровнях (в среднем $O(\log n)$ уровней), с поиском на уровне за $O\left(\frac{\log n}{\log M}\right)$. Общая сложность построения — $O(n \log n)$. Объём памяти — порядка $O(n M \log n)$. Параметр $ef_{construction}$ регулирует баланс между точностью и скоростью построения.
 

### Стадия поиска
Дано: запрос $q$, иерархический граф $\{G_l\}$, параметр качества поиска $ef_{search}$.
1. Инициализировать текущий узел $v$ — точку входа на верхнем уровне $L_{\max}$.
2. Для уровня $l = L_{\max}$ до 1:
    - Жадным поиском в графе $G_l$, начиная с $v$, найти ближайший узел $v^\star$ к $q$, или топ-$ef_{search}$ кандидатов, по правилу:
$$u^\star = \widetilde{\arg\min}_{u \in \mathcal{N}(v)} d(q, u)$$переход к $u^\star$, если $d(q, u^\star) < d(q, v)$.
Установить $v \leftarrow v^\star$ как старт для следующего уровня.
3. На уровне 0:

    - Выполнить более детальный жадный поиск начиная с $v$, вести приоритетную очередь из топ-$k$ кандидатов.
    - Вернуть множество приближённых $k$ ближайших соседей.
    - Результат гарантирует ошибку приблизительно:

где $x^\star$ — точный сосед, а $\epsilon$ зависит от $ef_{search}$.
___